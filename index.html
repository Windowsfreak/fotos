<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./node_modules/photoswipe/dist/photoswipe.css">
    <link rel="stylesheet" href="./node_modules/photoswipe/dist/default-skin/default-skin.css">
    <link rel="stylesheet" href="./node_modules/minireset.css/minireset.min.css">
    <link rel="stylesheet" href="./flex.css">
    <style>
        body {
            background-color: #000;
            color: #fff;
        }
        h2 {
            font-size: 2em;
        }
        h2 a {
            display: inline-block;
            border: 1px solid rgba(255,255,255,.3);
            border-radius: 10px;
            padding: 5px 10px;
            text-decoration: none;
            color: black;
            background-color: #ccc;
        }
        #breadcrumbs a:last-child {
            background-color: #fff;
            font-weight: bold;
        }
        #folders {
            display: flex;
            flex-wrap: wrap;
        }
        #folders a {
            font-size: 0.7em;
            display: block;
            width: 100%;
            max-width: 300px;
            padding: 10px 10px;
            background-color: #ccf;
        }
        h2 a div {
            border-radius: 10px;
            text-shadow: 0 1px 4px #000, 0 1px 8px #000;
            color: #fff;
        }
        #folders span {
            font-size: 0.5em;
            display: block;
        }
        .no {
            background-color: #f88 !important;
        }
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 1.02em; }
    </style>
</head>
<body>
<h2 id="breadcrumbs"></h2>
<h2 id="folders"></h2>
<div id="images" class="flex-images"></div>
<script type="javascript">
</script>
<script src="./node_modules/javascript-flex-images/flex-images.min.js"></script>
<script>
</script>
<script src="./node_modules/photoswipe/dist/photoswipe.min.js"></script>
<script src="./node_modules/photoswipe/dist/photoswipe-ui-default.min.js"></script>
<script>
    const root = './';
    function goto(path) {
        const target = event ? event.target : {};
        if (!path) {
            path = '.';
        }
        const xhr = new XMLHttpRequest();
        xhr.open('GET', encodeURI(root + path) + '/index.json');
        console.log(path);
        xhr.onload = function () {
            if (this.status >= 200 && this.status < 300) {
                try {
                    load(path, JSON.parse(xhr.response));
                    const x = location.hash.split('&');
                    x[0] = encodeURIComponent(path);
                    location.hash = x.join('&');
                } catch (e) {
                    console.log(e);
                    target.className = 'no';
                }
            } else {
                xhr.onerror();
            }
        };
        xhr.onerror = () => target.className = 'no';
        xhr.send();
    }
    function load(path, json) {
        setBreadcrumbs(path, `${dateStr(json.oldest)} - ${dateStr(json.newest)}`, json.c);
        setFolders(path, json.subs || []);
        setImages(path, json.imgs || []);
        new flexImages({selector: '#images', rowHeight: 200});
    }
    function drawBox(attrs, data, text) {
        const g=a=>[0,6,12,18].map(o=>a.slice(o,o+6)),
            c=g(data),b=n=>`background:linear-gradient(to right,#${c[n]},#${c[n+1]})`,m='mask:linear-gradient(to bottom,transparent,#fff)'
        return `<a ${attrs} style="${b(0)};position:relative"><div style="position:absolute;top:0;left:0;width:100%;height:100%;${b(2)};-webkit-${m};${m}"></div><div style="position:relative">${text}</div></a>`;
    }
    const options = {timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'}
    const dateStr = date => new Date(date).toLocaleString('de-DE', options);
    function setBreadcrumbs(file, date, c) {
        let str = '';
        let path = '';
        if (file) {
            file.split('/').forEach(folder => {
                path += folder;
                if (path == file) {
                    str += drawBox(`onclick="goto('${path}')" href="#"`, c, folder);
                } else {
                    str += `<a onclick="goto('${path}')" href="#">${folder}</a>`;
                }
                path += '/';
            });
        }
        document.getElementById('breadcrumbs').innerHTML = `${str} ${date}`;
    }
    plural = (x, sg, pl) => `${x || 0} ${sg}` + (x !== 1 ? pl : '');
    function setFolders(file, folders) {
        var str = '';
        folders.forEach(folder => {
            const i = [];
            folder.images && i.push(plural(folder.images, 'Foto', 's'))
            folder.files && i.push(plural(folder.files, 'Datei', 'en'))
            const i_str = i.length ? '<span>' + i.join(', ') + '</span>' : ''
            str += drawBox(`onclick="goto('${file ? file + '/' : ''}${folder.n}')" href="#"`, folder.c, folder.n +
                i_str +
                (folder.folders ? `<span>${folder.totalImages ? plural(folder.totalImages, 'Foto', 's') + ' in ' + plural(folder.folders, 'Ordner', 'n') : `enth√§lt ${folder.folders} Ordner`}</span>` : '') +
                (folder.newest !== '0001-01-01T00:00:00Z' ? `<span>${dateStr(folder.oldest)} - ${dateStr(folder.newest)}</span>` : '')
            );
        });
        document.getElementById('folders').innerHTML = str;
    }
    function setImages(file, images) {
        var str = '';
        var imgs = [];
        images.forEach(image => {
            str += drawBox(`class="item" href="${root}${file}/${image.n}.h.webp"\
            data-w="${image.w}"\
            data-h="${image.h}" data-name="${image.n}"`, image.c, `<img src="${root}${file}/${image.n}.s.webp">`);
            imgs.push({
                src: `${root}${file}/${image.n}.h.webp`,
                w: image.w,
                h: image.h,
                title: `${image.n} - ${dateStr(image.d)} - ${image.w} x ${image.h}`,
                msrc: `${root}${file}/${image.n}.s.webp`
            });
        });
        window.items = imgs;
        document.getElementById('images').innerHTML = str;
    }
    document.getElementById('images').onclick = function(event) {
        var elm = event.target;
        while (elm.className !== 'item') {
            elm = elm.parentElement;
        }
        var pswpElement = document.querySelectorAll('.pswp')[0];
        var options = {
            index: Array.prototype.indexOf.call(elm.parentElement.children, elm),
            getThumbBoundsFn: function(index) {
                var pageYScroll = window.pageYOffset || document.documentElement.scrollTop;
                // get position of element relative to viewport
                var rect = elm.parentElement.children[index].getBoundingClientRect();
                return {x:rect.left, y:rect.top + pageYScroll, w:rect.width};
            },
            showAnimationDuration: 100,
            hideAnimationDuration: 200
        };

        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
        gallery.init();
        return false;
    };
    goto(decodeURIComponent(location.hash.split('&')[0].replace('#', '')));
</script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
</body>
</html>
